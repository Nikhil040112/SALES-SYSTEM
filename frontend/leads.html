{% extends "base.html" %}
{% block title %}My Leads - Sales Pro{% endblock %}

{% block content %}
<div style="max-width:1120px;margin:0 auto;padding:12px 0 32px;">

  <!-- Heading -->
  <div style="margin-bottom:20px;">
    <div style="font-size:26px;font-weight:800;letter-spacing:-0.02em;">
      My leads
      <span style="
        display:inline-block;
        margin-left:10px;
        padding:4px 10px;
        border-radius:999px;
        background:#eef2ff;
        font-size:13px;
        font-weight:600;
        color:#4b5563;">
        Assigned to you
      </span>
    </div>
    <p style="margin:6px 0 0;font-size:15px;color:#6b7280;">
      View all leads assigned to you and jump straight to logging the first call.
    </p>
  </div>

  <!-- Card -->
  <div style="
    background:#ffffff;
    border-radius:18px;
    border:1px solid #e5e7eb;
    box-shadow:0 12px 36px rgba(15,23,42,0.08);
  ">
    <div style="
      padding:16px 20px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    ">
      <div>
        <div style="font-weight:800;font-size:17px;">Lead list</div>
        <div style="font-size:14px;color:#6b7280;">
          Click a lead to open the call form pre-filled with their details.
        </div>
      </div>
      <button onclick="loadLeads()" style="
        border:none;
        padding:8px 16px;
        border-radius:999px;
        background:#2563eb;
        color:#ffffff;
        font-size:14px;
        font-weight:700;
        cursor:pointer;">
        Refresh
      </button>
    </div>

    <!-- ðŸ” SEARCH (NO UI CHANGE â€“ SAME CARD FLOW) -->
    <div style="padding:10px 20px;border-bottom:1px solid #e5e7eb;">
      <input
        id="leadSearch"
        type="text"
        placeholder="Search by customer name or contact number"
        oninput="filterLeads()"
        style="
          width:100%;
          padding:10px 14px;
          border-radius:12px;
          border:1px solid #d1d5db;
          font-size:14px;
          outline:none;
        "
      />
    </div>

    <!-- Empty State -->
    <div id="emptyState" style="display:none;text-align:center;padding:48px 16px;">
      <div style="font-size:40px;margin-bottom:10px;">ðŸ“­</div>
      <div style="font-size:18px;font-weight:800;margin-bottom:6px;">
        No new leads
      </div>
      <div style="font-size:14px;color:#6b7280;max-width:360px;margin:0 auto;">
        Leads assigned to you will appear here automatically.
      </div>
    </div>

    <!-- List -->
    <div id="listWrapper" style="max-height:480px;overflow-y:auto;padding:6px 0;">
      <ul id="leads" style="list-style:none;margin:0;padding:0;"></ul>
    </div>
  </div>
</div>

<style>
.lead-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-bottom:1px solid #f3f4f6;
  cursor:pointer;
  transition:background .2s ease, transform .2s ease;
}
.lead-item:last-child{
  border-bottom:none;
}
.lead-item:hover{
  background:#f3f4ff;
  transform:translateX(4px);
}
.lead-main{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.lead-title{
  font-weight:800;
  font-size:15px;
  color:#111827;
}
.lead-sub{
  font-size:13px;
  color:#6b7280;
}
.lead-meta{
  font-size:13px;
  color:#6b7280;
  text-align:right;
}
.lead-status{
  font-weight:800;
  font-size:13px;
  color:#2563eb;
}
</style>

<script>
let ALL_LEADS = [];

function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token"),
    "Content-Type": "application/json"
  };
}

function formatDate(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  return d.toLocaleDateString("en-IN", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

async function loadLeads() {
  const res = await fetch("/leads/my", { headers: headers() });

  if (res.status === 401) {
    window.location.href = "/login";
    return;
  }
  if (!res.ok) return;

  ALL_LEADS = await res.json();
  renderLeads(ALL_LEADS);
}

function renderLeads(data) {
  const ul = document.getElementById("leads");
  const emptyState = document.getElementById("emptyState");
  const listWrapper = document.getElementById("listWrapper");

  ul.innerHTML = "";

  if (!Array.isArray(data) || !data.length) {
    emptyState.style.display = "block";
    listWrapper.style.display = "none";
    return;
  }

  emptyState.style.display = "none";
  listWrapper.style.display = "block";

  data.forEach(function (l) {
    const li = document.createElement("li");
    li.className = "lead-item";

    li.innerHTML = `
      <div class="lead-main">
        <span class="lead-title">${l.client_name || "Unnamed Client"}</span>
        <span class="lead-sub">
          ${l.contact_number || ""} Â· ${l.query_source || "Unknown source"}
        </span>
        <span class="lead-sub">
          ${l.query_product || "No product"}${l.state ? " Â· " + l.state : ""}
        </span>
      </div>
      <div class="lead-meta">
        <div class="lead-status">${l.status || ""}</div>
        <div>${formatDate(l.created_at)}</div>
      </div>
    `;

    li.onclick = function () {
      window.location.href = "/call-details?lead_id=" + l.id;
    };

    ul.appendChild(li);
  });
}

function filterLeads() {
  const q = document.getElementById("leadSearch").value.toLowerCase().trim();

  if (!q) {
    renderLeads(ALL_LEADS);
    return;
  }

  const filtered = ALL_LEADS.filter(l =>
    (l.client_name || "").toLowerCase().includes(q) ||
    (l.contact_number || "").toString().includes(q)
  );

  renderLeads(filtered);
}

loadLeads();
</script>
{% endblock %}