{% extends "base.html" %}
{% block title %}Call Details - Sales Pro{% endblock %}

{% block content %}
<div style="max-width: 1120px; margin: 0 auto; padding: 8px 0 24px;">

  <!-- Heading -->
  <div style="margin-bottom:16px;">
    <div style="font-size:22px;font-weight:800;letter-spacing:-0.02em;">
      Log call
      <span style="
        display:inline-block;
        margin-left:8px;
        padding:2px 8px;
        border-radius:999px;
        background:#eef2ff;
        font-size:11px;
        font-weight:600;
        color:#4b5563;
      ">
        Capture client interactions
      </span>
    </div>
    <p style="margin:4px 0 0;font-size:13px;color:#6b7280;">
      Record every outbound or inbound call with essential context to keep your pipeline updated.
    </p>
  </div>

  <!-- Two-column layout -->
  <div style="
    display:grid;
    grid-template-columns:minmax(0,1.15fr) minmax(0,0.85fr);
    gap:14px;
  ">
    <!-- Call form -->
    <div style="
      background:#ffffff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    ">
      <div style="padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <div style="font-weight:700;font-size:15px;">Call details</div>
        <div style="font-size:12px;color:#6b7280;">Core contact, outcome, and notes.</div>
      </div>

      <div style="padding:14px 16px;">
        <form onsubmit="createCall(event)" style="display:flex;flex-direction:column;gap:10px;">

          <!-- Query source -->
          <div>
            <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
              Query source
            </label>
            <select id="query_source" style="
              width:100%;
              padding:8px 10px;
              border-radius:10px;
              border:1px solid #e5e7eb;
              font-size:13px;
              background:#f9fafb;
            ">
              <option value="">Select source</option>
              <option>INDIAMART</option>
              <option>FACEBOOK</option>
              <option>TRADE INDIA</option>
              <option>INSTAGRAM</option>
            </select>
          </div>

          <!-- Name + contact -->
          <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                Client name
              </label>
              <input id="client_name" required placeholder="Client name" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
              ">
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                Contact number
              </label>
              <input id="contact_number" required placeholder="Contact number" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
              ">
            </div>
          </div>

          <!-- Product + state -->
          <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                Product
              </label>
              <input id="query_product" placeholder="Product" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
              ">
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                State
              </label>
              <input id="state" placeholder="State" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
              ">
            </div>
          </div>

          <!-- Outcome + remarks -->
          <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                Call outcome
              </label>
              <select id="call_outcome" onchange="toggleFollowUpField()" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
                background:#f9fafb;
              ">
                <option value="">-- Not called yet --</option>
                <option>Connected</option>
                <option>Not Picked</option>
                <option>Busy</option>
                <option>Cut-In Between</option>
                <option>Not Required</option>
                <option>Purchased</option>
              </select>
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
                Remarks
              </label>
              <textarea id="remark" placeholder="Remark" rows="2" style="
                width:100%;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #e5e7eb;
                font-size:13px;
                resize:vertical;
              "></textarea>
            </div>
          </div>

          <!-- Follow-up -->
          <div id="followUpField" style="display:none;">
            <label style="display:block;font-size:12px;font-weight:600;color:#4b5563;margin-bottom:3px;">
              Follow-up date &amp; time
            </label>
            <input type="datetime-local" id="follow_up_datetime" style="
              width:100%;
              padding:8px 10px;
              border-radius:10px;
              border:1px solid #e5e7eb;
              font-size:13px;
            ">
          </div>

          <!-- Actions -->
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
            <button type="reset" style="
              border:1px solid #e5e7eb;
              background:#f9fafb;
              border-radius:999px;
              padding:6px 12px;
              font-size:12px;
              font-weight:600;
              cursor:pointer;
              color:#4b5563;
            ">
              Clear
            </button>
            <button type="submit" style="
              border:none;
              background:#2563eb;
              color:#ffffff;
              border-radius:999px;
              padding:6px 16px;
              font-size:13px;
              font-weight:600;
              cursor:pointer;
            ">
              Save
            </button>
          </div>

        </form>
      </div>
    </div>

    <!-- Recent calls -->
    <div style="
      background:#ffffff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    ">
      <div style="padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <div style="font-weight:700;font-size:15px;">My recent calls</div>
        <div style="font-size:12px;color:#6b7280;">Latest entries logged under your account.</div>
      </div>
      <div style="max-height:360px;overflow-y:auto;padding:6px 0;">
        <ul id="calls" style="list-style:none;margin:0;padding:0;font-size:13px;"></ul>
      </div>
    </div>
  </div>
</div>

<style>
#calls .list-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 12px;
  border-bottom:1px solid #f3f4f6;
}
#calls .list-item:last-child{
  border-bottom:none;
}
#calls .list-item-main{
  font-weight:600;
  color:#111827;
}
#calls .list-item-meta{
  font-size:11px;
  color:#6b7280;
}
@media (max-width: 900px){
  /* stack form and list on small screens */
  .page-shell > div{
    grid-template-columns:1fr !important;
  }
}
</style>

<script>
function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token"),
    "Content-Type": "application/json"
  };
}

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

/* FOLLOW-UP VISIBILITY LOGIC */
function toggleFollowUpField() {
  const outcome = call_outcome.value;
  const needsFollowUp = [
    "Connected",
    "Not Picked",
    "Busy",
    "Cut-In Between"
  ].includes(outcome);
  document.getElementById("followUpField").style.display = needsFollowUp ? "block" : "none";
}

/* LOAD LEAD (FIRST CALL MODE) */
async function loadLead() {
  const leadId = getQueryParam("lead_id");
  if (!leadId) return;

  const res = await fetch("/leads/" + leadId, { headers: headers() });
  if (!res.ok) return;

  const l = await res.json();

  query_source.value = l.query_source || "";
  client_name.value = l.client_name;
  contact_number.value = l.contact_number;
  query_product.value = l.query_product || "";
  state.value = l.state || "";

  call_outcome.required = true;
}

/* LOAD CALL FOR FOLLOW-UP EDIT */
async function loadCallForEdit() {
  const callId = getQueryParam("call_id");
  if (!callId) return;

  const res = await fetch("/calls/" + callId, { headers: headers() });
  if (!res.ok) return;

  const c = await res.json();

  query_source.value = c.query_source || "";
  client_name.value = c.client_name;
  contact_number.value = c.contact_number;
  query_product.value = c.query_product || "";
  state.value = c.state || "";
  remark.value = c.remark || "";

  call_outcome.required = true;
}

/* CREATE LEAD / FIRST CALL / FOLLOW-UP */
async function createCall(e) {
  e.preventDefault();

  const callId = getQueryParam("call_id");
  const leadId = getQueryParam("lead_id");

  const payload = {
    query_source: query_source.value,
    client_name: client_name.value,
    contact_number: contact_number.value,
    query_product: query_product.value,
    state: state.value,
    call_outcome: call_outcome.value || null,
    remark: remark.value,
    follow_up_datetime: follow_up_datetime.value || null
  };

  let url = "/calls";
  if (callId) {
    url = `/calls/${callId}/follow-up`;
  }

  await fetch(url, {
    method: "POST",
    headers: headers(),
    body: JSON.stringify(payload)
  });

  // REMOVE REDIRECT, JUST RESET + RELOAD RECENT CALLS
  e.target.reset();
  call_outcome.value = "";
  toggleFollowUpField();
  loadCalls();
}

/* LOAD RECENT CALLS */
async function loadCalls() {
  const res = await fetch("/calls/my", { headers: headers() });
  const data = await res.json();

  const list = document.getElementById("calls");
  list.innerHTML = "";
  data.forEach(c => {
    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML = `
      <span class="list-item-main">${c.client_name} - ${c.call_outcome}</span>
      <span class="list-item-meta">${c.state || "NA"}</span>
    `;
    list.appendChild(li);
  });
}

/* INIT */
loadCalls();
loadLead();
loadCallForEdit();
</script>
{% endblock %}