{% extends "base.html" %}
{% block title %}Dashboard - Sales Pro{% endblock %}

{% block content %}
<div style="max-width: 1120px; margin: 0 auto; padding: 8px 0 24px;">

  <!-- Heading -->
  <div style="margin-bottom:16px;">
    <div style="font-size:22px;font-weight:800;letter-spacing:-0.02em;">
      My dashboard
      <span style="
        display:inline-block;
        margin-left:8px;
        padding:2px 8px;
        border-radius:999px;
        background:#eef2ff;
        font-size:11px;
        font-weight:600;
        color:#4b5563;
      ">
        Personal performance snapshot
      </span>
    </div>
    <p style="margin:4px 0 0;font-size:13px;color:#6b7280;">
      Track your daily activity, open pipeline, and call outcomes at a glance.
    </p>
  </div>

  <!-- Two columns -->
  <div style="
    display:grid;
    grid-template-columns:minmax(0,1.25fr) minmax(0,0.9fr);
    gap:14px;
  ">

    <!-- Core metrics + breakdown -->
    <div style="
      background:#ffffff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    ">
      <div style="padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <div style="font-weight:700;font-size:15px;">Core metrics</div>
        <div style="font-size:12px;color:#6b7280;">Volume and status across all your calls.</div>
      </div>
      <div style="padding:14px 16px;">

        <!-- KPI row -->
        <div style="
          display:grid;
          grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
          gap:10px;
          margin-bottom:12px;
        ">
          <div class="metric-card">
            <div class="metric-label">Total calls</div>
            <div class="metric-value" id="totalCalls">0</div>
            <div class="metric-pill">All logged calls</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Open</div>
            <div class="metric-value" id="openCalls">0</div>
            <div class="metric-pill pill-open">OPEN / OVERDUE</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Closed</div>
            <div class="metric-value" id="closedCalls">0</div>
            <div class="metric-pill pill-closed">Marked as closed</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Today</div>
            <div class="metric-value" id="todayCalls">0</div>
            <div class="metric-pill">Calls created today</div>
          </div>
        </div>

        <!-- ðŸ”¹ LEAD INSIGHTS (NEW, UI SAFE) -->
        <div style="margin-top:12px;">
          <div style="font-size:12px;font-weight:600;color:#4b5563;margin-bottom:6px;">
            Lead insights
          </div>
          <div style="
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px;
          ">
            <div class="metric-card">
              <div class="metric-label">Total leads</div>
              <div class="metric-value" id="totalLeads">0</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">New leads</div>
              <div class="metric-value" id="newLeads">0</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Called leads</div>
              <div class="metric-value" id="calledLeads">0</div>
            </div>
          </div>
        </div>

        <!-- By outcome -->
        <div style="margin-top:12px;">
          <div style="font-size:12px;font-weight:600;color:#4b5563;margin-bottom:4px;">
            By outcome
          </div>
          <div style="max-height:190px;overflow-y:auto;">
            <ul id="outcomeStats" style="list-style:none;margin:0;padding:0;"></ul>
          </div>
        </div>

        <!-- By source -->
        <div style="margin-top:10px;">
          <div style="font-size:12px;font-weight:600;color:#4b5563;margin-bottom:4px;">
            By source
          </div>
          <div style="max-height:190px;overflow-y:auto;">
            <ul id="sourceStats" style="list-style:none;margin:0;padding:0;"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent calls -->
    <div style="
      background:#ffffff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    ">
      <div style="padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <div style="font-weight:700;font-size:15px;">Recent calls</div>
        <div style="font-size:12px;color:#6b7280;">The last 10 calls sorted by time.</div>
      </div>
      <div style="max-height:360px;overflow-y:auto;padding:6px 0;">
        <ul id="recentCalls" style="list-style:none;margin:0;padding:0;"></ul>
      </div>
    </div>
  </div>
</div>

<style>
.metric-card{
  background:#f9fafb;
  border-radius:10px;
  border:1px solid #e5e7eb;
  padding:8px 10px;
}
.metric-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.06em;
  color:#6b7280;
  margin-bottom:2px;
}
.metric-value{
  font-size:20px;
  font-weight:700;
  color:#111827;
}
.metric-pill{
  margin-top:3px;
  font-size:11px;
  color:#6b7280;
}
.pill-open{ color:#b45309; }
.pill-closed{ color:#166534; }

#outcomeStats .list-item,
#sourceStats .list-item,
#recentCalls .list-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid #f3f4f6;
  font-size:13px;
}
.list-item-main{ font-weight:600; }
.list-item-meta{ font-size:11px;color:#6b7280; }
</style>

<script>
function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token"),
    "Content-Type": "application/json"
  };
}

function isToday(dateStr) {
  const d = new Date(dateStr);
  const n = new Date();
  return d.toDateString() === n.toDateString();
}

async function loadDashboard() {
  const [callsRes, leadsRes] = await Promise.all([
    fetch("/calls/my", { headers: headers() }),
    fetch("/leads/my", { headers: headers() })
  ]);

  const calls = await callsRes.json();
  const leads = await leadsRes.json();

  // ----- CALL METRICS -----
  let open = 0, closed = 0, today = 0;
  const outcomes = {}, sources = {};

  calls.forEach(c => {
    if (c.status === "OPEN" || c.status === "OVERDUE") open++;
    if (c.status === "CLOSED") closed++;
    if (isToday(c.created_at)) today++;

    outcomes[c.call_outcome || "Unknown"] =
      (outcomes[c.call_outcome || "Unknown"] || 0) + 1;

    sources[c.query_source || "Unknown"] =
      (sources[c.query_source || "Unknown"] || 0) + 1;
  });

  totalCalls.textContent = calls.length;
  openCalls.textContent = open;
  closedCalls.textContent = closed;
  todayCalls.textContent = today;

  // ----- LEAD METRICS -----
  totalLeads.textContent = leads.length;
  newLeads.textContent = leads.filter(l => l.status === "NEW").length;
  calledLeads.textContent = leads.filter(l => l.status === "CALLED").length;

  // ----- LISTS -----
  outcomeStats.innerHTML = "";
  Object.entries(outcomes).forEach(([k,v]) => {
    outcomeStats.innerHTML += `<li class="list-item">
      <span class="list-item-main">${k}</span>
      <span class="list-item-meta">${v} calls</span>
    </li>`;
  });

  sourceStats.innerHTML = "";
  Object.entries(sources).forEach(([k,v]) => {
    sourceStats.innerHTML += `<li class="list-item">
      <span class="list-item-main">${k}</span>
      <span class="list-item-meta">${v} calls</span>
    </li>`;
  });

  recentCalls.innerHTML = "";
  calls
    .sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
    .slice(0,10)
    .forEach(c=>{
      recentCalls.innerHTML += `<li class="list-item">
        <span class="list-item-main">${c.client_name} - ${c.call_outcome}</span>
        <span class="list-item-meta">${c.state || "NA"}</span>
      </li>`;
    });
}

loadDashboard();
</script>
{% endblock %}
