{% extends "base.html" %}
{% block title %}My Follow-ups - Sales Pro{% endblock %}

{% block content %}
<div style="max-width: 1120px; margin: 0 auto; padding: 8px 0 24px;">

  <!-- Heading -->
  <div style="margin-bottom:16px;">
    <div style="font-size:24px;font-weight:800;letter-spacing:-0.02em;">
      My follow-ups
      <span style="
        display:inline-block;
        margin-left:8px;
        padding:2px 8px;
        border-radius:999px;
        background:#eef2ff;
        font-size:12px;
        font-weight:600;
        color:#4b5563;
      ">
        Upcoming & overdue actions
      </span>
    </div>
    <p style="margin:6px 0 0;font-size:14px;color:#6b7280;">
      See all calls that require your follow-up, sorted by date.
    </p>
  </div>

  <!-- Card -->
  <div style="
    background:#ffffff;
    border-radius:16px;
    border:1px solid #e5e7eb;
    box-shadow:0 10px 30px rgba(15,23,42,0.08);
  ">
    <div style="padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;font-size:16px;">Follow-up queue</div>
        <div style="font-size:13px;color:#6b7280;">Click a row to open call details and log the next step.</div>
      </div>
      <button
        onclick="loadFollowups()"
        style="
          border:none;
          padding:7px 14px;
          border-radius:999px;
          background:#2563eb;
          color:#ffffff;
          font-size:13px;
          font-weight:600;
          cursor:pointer;
        "
      >
        Refresh
      </button>
    </div>

    <!-- ðŸ” SEARCH BAR -->
    <div style="padding:10px 16px;border-bottom:1px solid #e5e7eb;">
      <input
        id="searchInput"
        type="text"
        placeholder="Search by customer name or contact number"
        oninput="filterFollowups()"
        style="
          width:100%;
          padding:10px 14px;
          border-radius:12px;
          border:1px solid #d1d5db;
          font-size:14px;
          outline:none;
        "
      />
    </div>

    <div id="emptyState" style="display:none;text-align:center;padding:32px 16px;">
      <div style="font-size:32px;margin-bottom:8px;">âœ…</div>
      <div style="font-size:16px;font-weight:700;margin-bottom:4px;">No pending follow-ups</div>
      <div style="font-size:14px;color:#6b7280;max-width:320px;margin:0 auto;">
        All your calls are up to date. New follow-ups will appear here automatically.
      </div>
    </div>

    <div id="listWrapper" style="max-height:420px;overflow-y:auto;padding:6px 0;">
      <ul id="followups" style="list-style:none;margin:0;padding:0;"></ul>
    </div>
  </div>
</div>

<style>
.followup-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 14px;
  border-bottom:1px solid #f3f4f6;
  font-size:14px;
  cursor:pointer;
  transition:background .2s ease, transform .2s ease;
}
.followup-item:last-child{border-bottom:none;}
.followup-item:hover{
  background:#f3f4ff;
  transform:translateX(4px);
}
.followup-main{
  display:flex;
  flex-direction:column;
}
.followup-title{
  font-weight:700;
  color:#111827;
  font-size:15px;
}
.followup-sub{
  font-size:13px;
  color:#6b7280;
}
.followup-meta{
  text-align:right;
  font-size:12px;
  color:#6b7280;
}
.badge-overdue{
  display:inline-block;
  margin-left:6px;
  padding:2px 6px;
  border-radius:999px;
  background:#fee2e2;
  color:#b91c1c;
  font-size:10px;
  font-weight:600;
  text-transform:uppercase;
}
.badge-today{
  display:inline-block;
  margin-left:6px;
  padding:2px 6px;
  border-radius:999px;
  background:#dcfce7;
  color:#166534;
  font-size:10px;
  font-weight:600;
  text-transform:uppercase;
}
</style>

<script>
let ALL_FOLLOWUPS = [];

function headers() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token"),
    "Content-Type": "application/json"
  };
}

function isToday(dateStr){
  if (!dateStr) return false;
  const d = new Date(dateStr);
  const now = new Date();
  return d.toDateString() === now.toDateString();
}

async function loadFollowups() {
  const res = await fetch("/calls/follow-ups", { headers: headers() });
  if (!res.ok) return;

  ALL_FOLLOWUPS = await res.json();
  renderFollowups(ALL_FOLLOWUPS);
}

function filterFollowups(){
  const q = document.getElementById("searchInput").value.toLowerCase().trim();

  if (!q){
    renderFollowups(ALL_FOLLOWUPS);
    return;
  }

  const filtered = ALL_FOLLOWUPS.filter(f =>
    (f.client_name || "").toLowerCase().includes(q) ||
    (f.contact_number || "").toString().includes(q)
  );

  renderFollowups(filtered);
}

function renderFollowups(data){
  const ul = document.getElementById("followups");
  const emptyState = document.getElementById("emptyState");
  const listWrapper = document.getElementById("listWrapper");

  ul.innerHTML = "";

  if (!data.length){
    emptyState.style.display = "block";
    listWrapper.style.display = "none";
    return;
  }

  emptyState.style.display = "none";
  listWrapper.style.display = "block";

  data.sort((a,b) => new Date(a.follow_up_datetime || 0) - new Date(b.follow_up_datetime || 0));

  data.forEach(f => {
    const li = document.createElement("li");
    li.className = "followup-item";

    const dt = f.follow_up_datetime ? new Date(f.follow_up_datetime) : null;
    const dateLabel = dt ? dt.toLocaleString('en-IN') : "No date";

    let badge = "";
    if (f.is_overdue) badge = "<span class='badge-overdue'>Overdue</span>";
    else if (dt && isToday(f.follow_up_datetime)) badge = "<span class='badge-today'>Today</span>";

    li.innerHTML = `
      <div class="followup-main">
        <span class="followup-title">
          ${f.client_name} â€“ ${f.call_outcome || "N/A"} ${badge}
        </span>
        <span class="followup-sub">
          ${f.contact_number || "No contact"} Â· ${f.query_product || "No product"} Â· ${f.state || "NA"}
        </span>
      </div>
      <div class="followup-meta">
        ${dateLabel}
      </div>
    `;

    li.onclick = () => {
      window.location.href = "/call-details?call_id=" + f.id;
    };

    ul.appendChild(li);
  });
}

loadFollowups();
</script>
{% endblock %}